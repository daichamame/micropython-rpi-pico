"""
DFPLAYER、SSD1306、ジョイスティックを使用して
SDカードの音楽を聴いてみる

"""

import daichamame_dfplayer
import daichamame_ssd1306
import daichamame_joystick
import time

#　フォント
num_font=(
[0x00    ,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], # 空白
[0x2E    ,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00], #.
[0x2F    ,0x00,0x00,0x04,0x04,0x0C,0x08,0x08,0x18,0x10,0x10,0x30,0x20,0x20,0x20,0x00,0x00], #/
[0x30    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #0
[0x31    ,0x00,0x38,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00], #1
[0x32    ,0x00,0x3C,0x42,0x42,0x02,0x02,0x02,0x02,0x3C,0x40,0x40,0x40,0x42,0x3E,0x00,0x00], #2
[0x33    ,0x00,0x3C,0x42,0x42,0x42,0x02,0x02,0x3C,0x02,0x02,0x42,0x42,0x42,0x3C,0x00,0x00], #3
[0x34    ,0x00,0x04,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x7E,0x04,0x04,0x04,0x00,0x00], #4
[0x35    ,0x00,0x3C,0x40,0x40,0x40,0x40,0x3C,0x02,0x02,0x02,0x02,0x42,0x42,0x3C,0x00,0x00], #5
[0x36    ,0x00,0x3C,0x42,0x42,0x40,0x40,0x7C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #6
[0x37    ,0x00,0x7E,0x42,0x42,0x02,0x02,0x04,0x04,0x04,0x04,0x08,0x08,0x08,0x08,0x00,0x00], #7
[0x38    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #8
[0x39    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3E,0x02,0x42,0x42,0x42,0x3C,0x00,0x00], #9
[0x3A    ,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00], #:
)
# リピートアイコン
music_icon=(
[0x0000,0x0000,0x0010,0x0FF8,0x1FFC,0x381E,0x301E,0x2030,0x0C04,0x780C,0x781C,0x3FF8,0x1FF0,0x0800,0x0000,0x0000],#リピート
)
# 音量アイコン(16x16)
vol_icon=(
[0x0000,0x0000,0x0600,0x0E00,0x1E00,0x1E00,0x7E00,0x7E00,0x7E00,0x7E00,0x1E00,0x1E00,0x0E00,0x0600,0x0000,0x0000],#音声0
[0x0000,0x0000,0x0600,0x0E00,0x1E00,0x1E00,0x7E80,0x7E80,0x7E80,0x7E80,0x1E00,0x1E00,0x0E00,0x0600,0x0000,0x0000],#音声1
[0x0000,0x0000,0x0600,0x0E00,0x1E20,0x1E20,0x7EA0,0x7EA0,0x7EA0,0x7EA0,0x1E20,0x1E20,0x0E00,0x0600,0x0000,0x0000],#音声2
[0x0000,0x0000,0x0608,0x0E08,0x1E28,0x1E28,0x7EA8,0x7EA8,0x7EA8,0x7EA8,0x1E28,0x1E28,0x0E08,0x0608,0x0000,0x0000],#音声3
[0x0000,0x0002,0x060A,0x0E0A,0x1E2A,0x1E2A,0x7EAA,0x7EAA,0x7EAA,0x7EAA,0x1E2A,0x1E2A,0x0E0A,0x060A,0x0002,0x0000],#音声4
)
band_icon=(
[0x1FFF,0x7FFF,0x7807,0xF003,0xE3F3,0xE3FB,0xE3FF,0xF3FF,0xF80F,0xFFE7,0xFFE3,0xEFE3,0xE7E3,0x6007,0x700F,0x1FFF],#S選択
[0xFFF8,0xFFFE,0xC03E,0xC01F,0xC7CF,0xC7E7,0xC7E3,0xC7E3,0xC7E3,0xC7E3,0xC7E3,0xC7E7,0xC7CF,0xC01E,0xC03E,0xFFF8],#D選択
)

# OLEDの初期化
ssd1306 = daichamame_ssd1306.SSD1306(rotate=0,font_array=num_font,font_size=16)
ssd1306.init()
ssd1306.clear()
ssd1306.flash()

# Joystickの初期化
jy = daichamame_joystick.JOYSTICK()
jy.init(threshold=16384)

# DFPlayer の初期化
dfplay = daichamame_dfplayer.DFPLAYER(uart_tx=16,uart_rx=17)
dfplay.reset() #　リセット
dfplay.set_volume(10)   # 音量設定
vol=dfplay.get_volume()	# 音量取得
total = dfplay.get_total_count() # SDカード内の局数取得
now_track = dfplay.get_track()	# 現在の曲番号取得
# OLED初期描画
ssd1306.draw_icon( 0, 0,band_icon[0],1,16)
ssd1306.draw_icon(16, 0,band_icon[1],1,16)
ssd1306.draw_icon(40, 0,music_icon[0],1,16)

ssd1306.draw_icon(80, 0,vol_icon[int((vol+1)/8)],1,16)  # Volアイコン表示
ssd1306.print(96,0,"{:03d}".format(vol),1)             # 音量表示
ssd1306.print(64,16,"/{:03d}".format(total),2)            # トータル曲数
ssd1306.print(16,16,"{:03d}".format(now_track),2)            # 再生曲番号
ssd1306.display() 
dfplay.set_repeat_play() # 繰り返し再生モードに設定
while 1:
    (v,h)=jy.check_value()	# ジョイスティックの値を取得
    if(v != 0):	# 縦方向に変化（ボリュームの変更）
        if(v<0 and vol < 30):
            dfplay.inc_volume()
        elif(v>0 and vol > 0):
            dfplay.dec_volume()
        vol=dfplay.get_volume()
        ssd1306.draw_icon(80, 0,vol_icon[int((vol+1)/8)],1,16) # Volアイコン更新
        ssd1306.print(96,0,"{:03d}".format(vol),1)            # 音量表示更新
        ssd1306.display()
    if(h != 0):	# 曲の変更
        if(h<0):
            dfplay.prev_music()
        elif(h>0):
            dfplay.next_music()
    # 現在の再生曲番号を取得
    track = dfplay.get_track()
    if(now_track != track and track <= total): # 番号が変わったら、表示の変更
        ssd1306.print(16,16,"{:03d}".format(track),2)
        ssd1306.display()
        now_track=track
    time.sleep_ms(600)
    