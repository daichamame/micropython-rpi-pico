"""
RDA5807MS、SSD1306、ジョイスティックを使用して
ラジオをつくって聴いてみる

"""

import daichamame_rda5807
import daichamame_ssd1306
import daichamame_joystick
import time

#　フォント
num_font=(
[0x00    ,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], # 空白
[0x2E    ,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00], #.
[0x2F    ,0x00,0x00,0x04,0x04,0x0C,0x08,0x08,0x18,0x10,0x10,0x30,0x20,0x20,0x20,0x00,0x00], #/
[0x30    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #0
[0x31    ,0x00,0x38,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00], #1
[0x32    ,0x00,0x3C,0x42,0x42,0x02,0x02,0x02,0x02,0x3C,0x40,0x40,0x40,0x42,0x3E,0x00,0x00], #2
[0x33    ,0x00,0x3C,0x42,0x42,0x42,0x02,0x02,0x3C,0x02,0x02,0x42,0x42,0x42,0x3C,0x00,0x00], #3
[0x34    ,0x00,0x04,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x7E,0x04,0x04,0x04,0x00,0x00], #4
[0x35    ,0x00,0x3C,0x40,0x40,0x40,0x40,0x3C,0x02,0x02,0x02,0x02,0x42,0x42,0x3C,0x00,0x00], #5
[0x36    ,0x00,0x3C,0x42,0x42,0x40,0x40,0x7C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #6
[0x37    ,0x00,0x7E,0x42,0x42,0x02,0x02,0x04,0x04,0x04,0x04,0x08,0x08,0x08,0x08,0x00,0x00], #7
[0x38    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00], #8
[0x39    ,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3E,0x02,0x42,0x42,0x42,0x3C,0x00,0x00], #9
[0x3A    ,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00], #:
)
# 音量アイコン(16x16)
vol_icon=(
[0x0000,0x0000,0x0600,0x0E00,0x1E00,0x1E00,0x7E00,0x7E00,0x7E00,0x7E00,0x1E00,0x1E00,0x0E00,0x0600,0x0000,0x0000],#音声0
[0x0000,0x0000,0x0600,0x0E00,0x1E00,0x1E00,0x7E80,0x7E80,0x7E80,0x7E80,0x1E00,0x1E00,0x0E00,0x0600,0x0000,0x0000],#音声1
[0x0000,0x0000,0x0600,0x0E00,0x1E20,0x1E20,0x7EA0,0x7EA0,0x7EA0,0x7EA0,0x1E20,0x1E20,0x0E00,0x0600,0x0000,0x0000],#音声2
[0x0000,0x0000,0x0608,0x0E08,0x1E28,0x1E28,0x7EA8,0x7EA8,0x7EA8,0x7EA8,0x1E28,0x1E28,0x0E08,0x0608,0x0000,0x0000],#音声3
[0x0000,0x0002,0x060A,0x0E0A,0x1E2A,0x1E2A,0x7EAA,0x7EAA,0x7EAA,0x7EAA,0x1E2A,0x1E2A,0x0E0A,0x060A,0x0002,0x0000],#音声4
)
# 切替
sel_icon=(
[0x1FFF,0x7FFF,0x6003,0xE003,0xE1FF,0xE1FF,0xE1FF,0xE007,0xE007,0xE1FF,0xE1FF,0xE1FF,0xE1FF,0x61FF,0x61FF,0x1FFF],#F選択
[0xFFF8,0xFFFE,0xC7C6,0xC7C7,0xC387,0xC107,0xC007,0xC447,0xC6C7,0xC7C7,0xC7C7,0xC7C7,0xC7C7,0xC7C6,0xC7C6,0xFFF8],#M選択
)
# 単位
freq_icon=(
[0x0000,0x0000,0x0000,0x0000,0x4510,0x6D10,0x6D10,0x6D10,0x6D10,0x6DF0,0x5517,0x5511,0x5512,0x5514,0x5517,0x0000], #MHz
)
# 変数
vol		= 10	# ボリューム（0-15）
ct = 0 # 周波数の番号
freq	= [80.0,81.3,82.5,90.5,91.6,93.0]	# 東京のラジオ局

# OLEDの初期化
ssd1306 = daichamame_ssd1306.SSD1306(rotate=0,font_array=num_font,font_size=16)
ssd1306.init()
ssd1306.clear()
ssd1306.flash()

# Joystickの初期化
jy = daichamame_joystick.JOYSTICK()
jy.init(threshold=16384)

# RDA5807の初期化
radio = daichamame_rda5807.RDA5807(id=0,scl_pin=5,sda_pin=4)
radio.init()
radio.set_volume(vol)		# ボリュームの設定
radio.set_freq(freq[ct])                  # 周波数の設定
# OLED初期描画
ssd1306.draw_icon(96, 0,vol_icon[int((vol+1)/4)],1,16)  # Volアイコン表示
ssd1306.print(112,0,"{:02d}".format(vol),1)             # 音量表示
ssd1306.draw_icon(  0,0,sel_icon[0],1,16)               # 文字Fを表示
ssd1306.draw_icon( 16,0,sel_icon[1],1,16)               # 文字Mを表示
ssd1306.print(32,16,str(freq[ct]),2)      # 周波数表示更新
ssd1306.draw_icon(112,32,freq_icon[0],1,16)             # 単位を表示
ssd1306.display()


while 1:
    (v,h)=jy.check_value()	# ジョイスティックの値を取得
    if(v != 0):	# 縦方向に変化（ボリュームの変更）
        vol = vol+(v<0)*(vol<15)+(v>0)*(vol>0)*(-1)            # ボリュームの計算
        radio.set_volume(vol)                                  # ボリュームの設定
        ssd1306.draw_icon(96, 0,vol_icon[int((vol+1)/4)],1,16) # Volアイコン更新
        ssd1306.print(112,0,"{:02d}".format(vol),1)            # 音量表示更新
        ssd1306.display()
    if(h != 0):	# 横方向の変化（周波数の変更）
        ct = ct+(h<0)*(ct>0)*(-1)+(h>0)*(ct<len(freq)-1)       # 表示周波数の計算
        radio.set_freq(freq[ct])                               # 周波数の設定
        ssd1306.print(32,16,str(freq[ct]),2)                   # 周波数表示更新
        ssd1306.display()   
    time.sleep_ms(200)

    